# Fixed-cost token sales contract in Stylus

Fixed-cost token sale contract that focuses on total number of tokens being sold and offers optional linear vesting of tokens (without cliff or instant unlock support).

If token vesting is enabled, users can tokenize the claim of tokens in an NFT allowing the owner of the NFT to have exclusivity on claiming the remaining unlocks (if applicable).

Current deployment: https://sepolia.arbiscan.io/address/0x6ca4cb7af1abab92897f58b7b93b005f81918c88

## Quick Start 

Install [Rust](https://www.rust-lang.org/tools/install), and then install the Stylus CLI tool with Cargo

```bash
cargo install --force cargo-stylus cargo-stylus-check
```

Add the `wasm32-unknown-unknown` build target to your Rust compiler:

```
rustup target add wasm32-unknown-unknown
```

You should now have it available as a Cargo subcommand:

```bash
cargo stylus --help
```

### Testnet Information

All testnet information, including faucets and RPC endpoints can be found [here](https://docs.arbitrum.io/stylus/reference/testnet-information).

### ABI Export

You can export the Solidity ABI for your program by using the `cargo stylus` tool as follows:

```bash
cargo stylus export-abi
```

which outputs:

```solidity
/**
 * This file was automatically generated by Stylus and represents a Rust program.
 * For more information, please see [The Stylus SDK](https://github.com/OffchainLabs/stylus-sdk-rs).
 */

// SPDX-License-Identifier: MIT-OR-APACHE-2.0
pragma solidity ^0.8.23;

interface ITokenSaleWithTokenizedVesting {
    function init(address token, address currency, uint256 price_per_token, uint256 total_tokens_available, uint256 total_vesting_length_in_seconds, address nft_claim) external;

    function purchaseTokens(uint256 amount) external;

    function enableTokenizedVesting(uint256 token_id) external;

    function claimTokens() external;

    function claimTokensByNft(address user) external;

    function claimUnlockedTokens() external;

    function updatePricePerToken(uint256 new_price_per_token) external;

    error OnlyOwner();

    error NotInitialized();

    error AlreadyInitialized();

    error ZeroValueArgumentInjected();

    error InvalidPercentage();

    error VestingLengthTooShort();

    error VestingLengthTooLong();

    error OnlyOnePurchase();

    error SoldOut();

    error VestingNotEnabled();

    error NoTokensVested();

    error NoTokensPurchased();

    error AlreadyTokenized();

    error AllTokensClaimed();

    error TokensAreVested();
}
```

Exporting ABIs uses a feature that is enabled by default in your Cargo.toml:

```toml
[features]
export-abi = ["stylus-sdk/export-abi"]
```

## Deploying

You can use the `cargo stylus` command to also deploy your program to the Stylus testnet. We can use the tool to first check
our program compiles to valid WASM for Stylus and will succeed a deployment onchain without transacting. By default, this will use the Stylus testnet public RPC endpoint. See here for [Stylus testnet information](https://docs.arbitrum.io/stylus/reference/testnet-information)

```bash
cargo stylus check
```

If successful, you should see something like:

```bash
Finished release [optimized] target(s) in 1.88s
Reading WASM file at stylus-hello-world/target/wasm32-unknown-unknown/release/stylus-hello-world.wasm
Compressed WASM size: 8.9 KB
Program succeeded Stylus onchain activation checks with Stylus version: 1
```

Next, we can estimate the gas costs to deploy and activate our program before we send our transaction. Check out the [cargo-stylus](https://github.com/OffchainLabs/cargo-stylus) README to see the different wallet options for this step:

```bash
cargo stylus deploy \
  --private-key-path=<PRIVKEY_FILE_PATH> \
  --estimate-gas
```

You will then see the estimated gas cost for deploying before transacting:

```bash
estimates
deployment tx gas: 5346383
gas price: "0.100000000" gwei
deployment tx total cost: "0.000534638300000000" ETH
```

The above only estimates gas for the deployment tx by default. To estimate gas for activation, first deploy your program using `--mode=deploy-only`, and then run `cargo stylus deploy` with the `--estimate-gas` flag, `--mode=activate-only`, and specify `--activate-program-address`.


Here's how to deploy:

```bash
cargo stylus deploy \
  --private-key-path=<PRIVKEY_FILE_PATH>
```

The CLI will send 2 transactions to deploy and activate your program onchain.

```bash
stripped custom section from user wasm to remove any sensitive data
contract size: 18.0 KB
wasm size: 67.2 KB
File used for deployment hash: ./Cargo.lock
File used for deployment hash: ./Cargo.toml
File used for deployment hash: ./rust-toolchain.toml
File used for deployment hash: ./src/lib.rs
File used for deployment hash: ./src/main.rs
project metadata hash computed on deployment: "c0ac65acdd571aa1efc49aa9b2697fc1159f359226fcae5d51fdc224952d5fa2"
stripped custom section from user wasm to remove any sensitive data
contract size: 18.0 KB
wasm data fee: 0.000098 ETH
deployed code at address: 0x6ca4cb7af1abab92897f58b7b93b005f81918c88
deployment tx hash: 0xeb1fc21e1349ffd7b2ba4c23b017fb42109ffbdc963fef0255958362d997ad1f
contract activated and ready onchain with tx hash: 0xb9511383bc1b07b2ea910301b003c68ca99fe2be851cfdfa30bc5cfb21551c0d

NOTE: We recommend running cargo stylus cache bid 6ca4cb7af1abab92897f58b7b93b005f81918c88 0 to cache your activated contract in ArbOS.
Cached contracts benefit from cheaper calls. To read more about the Stylus contract cache, see
https://docs.arbitrum.io/stylus/concepts/stylus-cache-manager
```

Once both steps are successful, you can interact with your program as you would with any Ethereum smart contract.

## Build Options

By default, the cargo stylus tool will build your project for WASM using sensible optimizations, but you can control how this gets compiled by seeing the full README for [cargo stylus](https://github.com/OffchainLabs/cargo-stylus). If you wish to optimize the size of your compiled WASM, see the different options available [here](https://github.com/OffchainLabs/cargo-stylus/blob/main/OPTIMIZING_BINARIES.md).

## Peeking Under the Hood

The [stylus-sdk](https://github.com/OffchainLabs/stylus-sdk-rs) contains many features for writing Stylus programs in Rust. It also provides helpful macros to make the experience for Solidity developers easier. These macros expand your code into pure Rust code that can then be compiled to WASM. If you want to see what the `stylus-hello-world` boilerplate expands into, you can use `cargo expand` to see the pure Rust code that will be deployed onchain.

First, run `cargo install cargo-expand` if you don't have the subcommand already, then:

```
cargo expand --all-features --release --target=<YOUR_ARCHITECTURE>
```

Where you can find `YOUR_ARCHITECTURE` by running `rustc -vV | grep host`. For M1 Apple computers, for example, this is `aarch64-apple-darwin`.

## License

This project is fully open source, including an Apache-2.0 or MIT license at your choosing under your own copyright.
